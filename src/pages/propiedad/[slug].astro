---
export const prerender = false;

import PropertyFeature from "../../components/property/PropertyFeature.astro";
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabaseClient";
import MainFeatures from "../../components/property/MainFeatures.astro";
import OtherFeatures from "../../components/property/OtherFeatures.astro";
import Map from "../../components/property/Map.astro";
import RelatedProperties from "../../components/property/RelatedProperties.astro";
import ButtonGalleryModal from "../../components/property/ButtonGalleryModal.jsx";

interface PropertyImage {
  url: string;
}

interface Property {
  id: string;
  title: string;
  description: string;
  price: number;
  estado: string;
  bedrooms: number;
  bathrooms: number;
  area: number;
  floors: number;
  parking: number;
  municipio: string;
  colonia: string;
  property_type: string;
  services: string[];
  amenities?: string[];
  property_images?: PropertyImage[];
}

const slugPropiedad = Astro.params.slug;

const { data, error } = await supabase
  .from("properties")
  .select(
    `
    id,
    title,
    description,
    price,
    bedrooms,
    bathrooms,
    area,
    floors,
    parking,
    estado,
    municipio,
    colonia,
    property_type,
    services,
    amenities, 
    property_images ( url )
  `,
  )
  .eq("slug", slugPropiedad)
  .maybeSingle<Property>();

if (error) {
  console.error("‚ùå Error fetching property:", error);
}

const propiedad: Property = data ?? {
  id: "",
  title: "",
  description: "",
  price: 0,
  bedrooms: 0,
  bathrooms: 0,
  area: 0,
  floors: 0,
  parking: 0,
  estado: "",
  municipio: "",
  colonia: "",
  property_type: "",
  services: [],
  amenities: [],
  property_images: [],
};

const fiveImages: string[] = Array.isArray(propiedad.property_images)
  ? propiedad.property_images.map((img) => img.url).slice(0, 5)
  : [];

// üß© 2Ô∏è‚É£ Propiedades similares: mismas ubicaci√≥n o tipo
const { data: similares, error: errorSimilares } = await supabase
  .from("properties")
  .select(
    `
    id,
    title,
    price,
    estado,
    municipio,
    colonia,
    price,
    property_type,
    slug,
    property_images ( url )
  `,
  )
  // ‚ùó criterio: mismo municipio o tipo, distinto id
  .or(
    `municipio.eq.${propiedad.municipio},property_type.eq.${propiedad.property_type}`,
  )
  .neq("id", propiedad.id)
  .limit(4);

if (errorSimilares) console.error("Error fetching similares:", errorSimilares);

const priceNormalized = propiedad.price.toLocaleString("es-MX", {
  style: "currency",
  currency: "MXN",
  minimumFractionDigits: 0,
});

---

<Layout title={propiedad.title}>
  <section class="w-11/12 md:w-10/12 lg:w-8/12 mx-auto">
    <header
      class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 relative lg:max-h-[600px] animate-[fadeIn_1s_ease-in-out_forwards]"
    >
      {
        fiveImages.map((image, index) => (
          <div
            class={`bg-neutral-400 overflow-hidden rounded-xl aspect-[4/3] h-full ${
              index === 0 ? "md:col-span-2 md:row-span-2" : ""
            }`}
          >
            <img
              src={image}
              alt={`Imagen ${index + 1} de ${propiedad.title}`}
              class="w-full h-full object-cover"
            />
          </div>
        ))
      }
      <div
        class="border bg-white w-max rounded-md cursor-pointer absolute right-4 bottom-4 text-sm font-bold"
      >
      {
        propiedad.property_images && propiedad.property_images.length > 5 && (
          <ButtonGalleryModal listImages={propiedad.property_images} client:load />
        )
      }
      </div>
    </header>
    <div
      class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 mt-8 relative animate-[fadeIn_1s_ease-in-out_forwards]"
    >
      <div class="col-span-2">
        <div class="border-b border-slate-300 py-4">
          <h1 class="text-3xl">{propiedad.title}</h1>
        </div>
        <!-- Component -->
        <div class="py-4 flex flex-col gap-4 border-b border-slate-300">
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <PropertyFeature
              label="Tipo"
              type="building"
              value={propiedad.property_type}
            />
            <PropertyFeature
              label="Recamaras"
              type="bedrooms"
              value={propiedad.bedrooms}
            />
            <PropertyFeature
              label="Ba√±os"
              type="bathrooms"
              value={propiedad.bathrooms}
            />
            <PropertyFeature
              label="Estacionamiento"
              type="parking"
              value={propiedad.parking}
            />
            <PropertyFeature
              label="Area (m¬≤)"
              type="area"
              value={propiedad.area}
            />
            <PropertyFeature
              label="Pisos"
              type="floors"
              value={propiedad.floors}
            />
          </div>
        </div>
        <!-- COmponent -->
        <div class="py-4 flex flex-col gap-4 border-b border-slate-300">
          <h2 class="text-xl font-semibold">Descripci√≥n</h2>
          <div class="flex flex-wrap gap-4">
            <p class="whitespace-pre-line">
              {propiedad.description}
            </p>
          </div>
        </div>
        <!-- Component -->
        <div class="py-4 flex flex-col gap-4 border-b border-slate-300">
          <h2 class="text-xl font-semibold">
            Servicios incluidos
          </h2>
          <MainFeatures services={propiedad.services} />
          { propiedad.amenities?.length ? (
            <h2 class="text-xl font-semibold">Amenidades</h2>
            <OtherFeatures services={propiedad.amenities} />
          ): null }
        </div>
        <div class="py-4 flex flex-col gap-4 border-b border-slate-300 mb-4">
          <h2 class="text-xl font-semibold">Ubicaci√≥n</h2>
          <div class="flex flex-wrap gap-8">
            <Map estado={propiedad.estado} municipio={propiedad.municipio} colonia={propiedad.colonia}  />
            <span
              >La informaci√≥n exacta de la ubicaci√≥n se proporciona por medio de
              Whatsapp.</span
            >
          </div>
        </div>
      </div>
      <div class="col-span-1">
        <div class="sticky top-28 md:px-4 w-full md:w-max">
          <div
            class="p-4 border border-slate-300 rounded-xl w-full flex flex-col gap-8 justify-center items-center"
          >
            <p class="text-3xl text-slate-800 font-semibold">
              {priceNormalized} MXN
            </p>
            <a
              href="#"
              class="border rounded-xl w-full flex items-center gap-4 py-3 px-4 bg-green-700 hover:bg-green-500 transition duration-200 text-white text-xl font-semibold"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                class="icon icon-tabler icons-tabler-outline icon-tabler-brand-whatsapp"
                ><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><path
                  d="M3 21l1.65 -3.8a9 9 0 1 1 3.4 2.9l-5.05 .9"></path><path
                  d="M9 10a.5 .5 0 0 0 1 0v-1a.5 .5 0 0 0 -1 0v1a5 5 0 0 0 5 5h1a.5 .5 0 0 0 0 -1h-1a.5 .5 0 0 0 0 1"
                ></path></svg
              >
              Mas informaci√≥n
            </a>
          </div>
        </div>
      </div>
    </div>
    <section class="w-full pb-20">
      <h2 class="text-2xl py-8">Propiedades similares</h2>
      <RelatedProperties property_type={propiedad.property_type} propertyID={propiedad.id} />
    </section>
  </section>
  </section>

  <style>
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
  </style>
</Layout>
